---
phase: 03-export-xero-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - server/src/routes/exports.ts
  - server/src/services/PdfExportService.ts
  - server/src/index.ts
  - client/src/App.tsx
  - client/src/components/print/PrintExecutiveSummary.tsx
  - client/src/components/print/PrintFinancial.tsx
  - client/src/components/print/PrintRegional.tsx
  - client/src/components/print/PrintTargets.tsx
  - client/src/components/print/PrintLayout.tsx
autonomous: false

must_haves:
  truths:
    - "Each dashboard page (Executive Summary, Financial, Regional, Target Management) can be exported as a branded PDF"
    - "PDF includes Buildable branding (company name from settings), page title, selected week, and generation timestamp"
    - "Financial and Regional PDFs use landscape orientation; Executive Summary and Targets use portrait"
    - "PDF renders all charts and tables with print-optimised layout (no interactive elements, no loading spinners)"
  artifacts:
    - path: "server/src/services/PdfExportService.ts"
      provides: "Puppeteer-based PDF generation from print routes"
      exports: ["generatePdf"]
    - path: "server/src/routes/exports.ts"
      provides: "GET /api/v1/exports/pdf/:page endpoint"
      contains: "router.get"
    - path: "client/src/components/print/PrintLayout.tsx"
      provides: "Shared print layout wrapper with branding header and footer"
      exports: ["PrintLayout"]
    - path: "client/src/components/print/PrintExecutiveSummary.tsx"
      provides: "Print-optimised Executive Summary page"
      contains: "data-print-ready"
  key_links:
    - from: "server/src/routes/exports.ts"
      to: "server/src/services/PdfExportService.ts"
      via: "generatePdf() call in route handler"
      pattern: "generatePdf"
    - from: "server/src/services/PdfExportService.ts"
      to: "client print routes"
      via: "Puppeteer navigates to http://localhost:4200/print/:page"
      pattern: "localhost:4200/print"
    - from: "client/src/App.tsx"
      to: "client/src/components/print/"
      via: "URL hash-based print route detection"
      pattern: "isPrintMode"

user_setup:
  - service: puppeteer
    why: "Headless Chromium for PDF rendering"
    env_vars: []
    dashboard_config:
      - task: "Verify Puppeteer Chromium downloads on Windows 11 target"
        location: "Run 'cd server && npm install puppeteer' on production machine. If blocked by firewall, set PUPPETEER_EXECUTABLE_PATH to Edge path."
---

<objective>
Build server-side PDF export using Puppeteer: install Puppeteer, create print-optimised page variants on the client, create the PDF generation service and API route, and register the route on the server.

Purpose: Directors need branded PDF snapshots of dashboard pages for board meetings, investor reports, and offline review.
Output: Working PDF download from all 4 dashboard pages with branding, proper orientation, and print-optimised layout.
</objective>

<execution_context>
@C:/Users/Dev180D/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dev180D/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-export-xero-integration/03-RESEARCH.md
@.planning/phases/03-export-xero-integration/03-01-SUMMARY.md

Key codebase files:
@client/src/App.tsx
@client/src/components/dashboard/ExecutiveSummary.tsx
@client/src/components/dashboard/FinancialDeepDive.tsx
@client/src/components/dashboard/RegionalPerformance.tsx
@client/src/components/targets/TargetManagement.tsx
@client/src/lib/dashboardApi.ts
@client/src/lib/SettingsContext.tsx
@server/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Puppeteer and create PDF generation service + API route</name>
  <files>
    server/package.json
    server/src/services/PdfExportService.ts
    server/src/routes/exports.ts
    server/src/index.ts
  </files>
  <action>
**Install Puppeteer:**
```bash
cd server && npm install puppeteer
```

**Create `server/src/services/PdfExportService.ts`:**

Define a page config map:
```typescript
const PAGE_CONFIG: Record<string, { landscape: boolean; title: string }> = {
  'executive-summary': { landscape: false, title: 'Executive Summary' },
  'financial':         { landscape: true,  title: 'Financial Deep Dive' },
  'regional':          { landscape: true,  title: 'Regional Performance' },
  'targets':           { landscape: false, title: 'Target Management' },
};
```

Export `generatePdf(pageSlug: string, weekEnding: string): Promise<Buffer>`:
1. Validate pageSlug exists in PAGE_CONFIG, throw if not
2. Launch Puppeteer headless browser with args `['--no-sandbox', '--disable-setuid-sandbox']`
3. If `process.env.PUPPETEER_EXECUTABLE_PATH` is set, use it as `executablePath` (Edge fallback for Windows)
4. Create new page, set viewport to `{ width: 1280, height: 900 }`
5. Navigate to `http://localhost:${process.env.CLIENT_PORT || 4200}/#/print/${pageSlug}?week=${weekEnding}` with `waitUntil: 'networkidle0'` and `timeout: 30000`
6. Wait for selector `[data-print-ready="true"]` with timeout 15000ms
7. Call `page.pdf()` with:
   - `format: 'A4'`
   - `landscape` from PAGE_CONFIG
   - `printBackground: true`
   - `displayHeaderFooter: true`
   - `headerTemplate`: Div with font-size 9px, width 100%, padding 0 20px, flexbox space-between. Left: "Buildable Approvals Pty Ltd". Right: "Week ending: {weekEnding formatted DD/MM/YYYY}".
   - `footerTemplate`: Div with font-size 8px, center-aligned, color #999. Content: "Page <span class='pageNumber'></span> of <span class='totalPages'></span> -- Generated {current date DD/MM/YYYY HH:mm}"
   - `margin: { top: '80px', bottom: '60px', left: '40px', right: '40px' }`
8. Close browser in a `finally` block (CRITICAL -- never leak browser processes)
9. Return the PDF buffer

**Create `server/src/routes/exports.ts`:**

Express Router with one route:

`GET /pdf/:page` (query param: `week` required):
1. Validate `page` param is a known page slug (executive-summary, financial, regional, targets). Return 400 if not.
2. Validate `week` query param exists and is a valid date string. Return 400 if missing.
3. Call `generatePdf(page, week)` wrapped in try/catch
4. On success: set headers `Content-Type: application/pdf`, `Content-Disposition: attachment; filename="{title} - {week}.pdf"`. Send buffer.
5. On error: return 500 with `{ error: 'PDF generation failed', details: err.message }`

**Update `server/src/index.ts`:**

1. Import exports routes: `import exportsRoutes from './routes/exports.js';`
2. Register AFTER auth middleware: `app.use('/api/v1/exports', exportsRoutes);`
  </action>
  <verify>
    - `cd server && npx tsc --noEmit` compiles (expect pre-existing Prisma type warnings only)
    - `node -e "require('puppeteer')"` in server directory succeeds (Puppeteer installed)
    - Server starts without errors: `cd server && npx tsx src/index.ts` (check it binds to port 6001)
    - `curl http://localhost:6001/api/v1/exports/pdf/executive-summary?week=2025-01-25` returns a response (may error if client print route not ready yet, but should not 404)
  </verify>
  <done>
    - Puppeteer installed in server
    - PdfExportService generates PDFs with branded header/footer, correct orientation per page
    - Export route registered at /api/v1/exports/pdf/:page
    - Edge fallback via PUPPETEER_EXECUTABLE_PATH env var
  </done>
</task>

<task type="auto">
  <name>Task 2: Create print-optimised page variants on client</name>
  <files>
    client/src/App.tsx
    client/src/components/print/PrintLayout.tsx
    client/src/components/print/PrintExecutiveSummary.tsx
    client/src/components/print/PrintFinancial.tsx
    client/src/components/print/PrintRegional.tsx
    client/src/components/print/PrintTargets.tsx
  </files>
  <action>
**IMPORTANT:** The app does NOT use react-router. It uses state-based page switching in App.tsx. For print routes, use URL hash routing: detect `window.location.hash` starting with `#/print/` and render the print page variant instead of the normal app shell.

**Update `client/src/App.tsx`:**

Add print mode detection at the top of the `App` component:
```typescript
const [printMode, setPrintMode] = useState<string | null>(null);

useEffect(() => {
  function checkHash() {
    const hash = window.location.hash;
    if (hash.startsWith('#/print/')) {
      setPrintMode(hash.replace('#/print/', '').split('?')[0]);
    } else {
      setPrintMode(null);
    }
  }
  checkHash();
  window.addEventListener('hashchange', checkHash);
  return () => window.removeEventListener('hashchange', checkHash);
}, []);
```

Extract `week` from URL search params: `new URLSearchParams(window.location.hash.split('?')[1] || '')`.

If `printMode` is set, render the corresponding print component instead of the normal app shell:
```typescript
if (printMode) {
  return (
    <SettingsProvider>
      <WeekProvider>
        <PrintRouter page={printMode} />
      </WeekProvider>
    </SettingsProvider>
  );
}
```

Create a `PrintRouter` inline component or import that maps slug to print component:
- `'executive-summary'` -> `<PrintExecutiveSummary />`
- `'financial'` -> `<PrintFinancial />`
- `'regional'` -> `<PrintRegional />`
- `'targets'` -> `<PrintTargets />`

The week param from the hash URL should override the WeekContext selected week. Pass it as a prop or use a print-specific context.

**Create `client/src/components/print/PrintLayout.tsx`:**

A shared wrapper for all print pages:
```typescript
interface PrintLayoutProps {
  title: string;
  weekEnding: string;
  children: React.ReactNode;
}
```

Layout:
1. White background, no sidebar, no topbar
2. Header: Company name (from useSettings branding, or fallback "Buildable Approvals"), page title, week ending (formatted DD/MM/YYYY)
3. Content area: children
4. Set `data-print-ready="true"` on the root div AFTER data is loaded (pass a `ready` prop or detect from children)
5. Add CSS via `<style>` tag in the component:
   - `@media print { body { margin: 0; } }`
   - No scrollbars, fixed widths (1200px for portrait, 1600px for landscape)
   - Hide any scrollbars
6. Disable all hover effects, transitions, animations

**Create print page components (one for each dashboard page):**

Each print page component should:
1. Fetch the same data as the regular dashboard page (reuse the API functions from dashboardApi.ts)
2. Use the `week` from URL params (not WeekContext) to fetch data
3. Render tables and charts in a print-friendly layout:
   - Tables: Full-width, clean borders, zebra striping, readable font sizes
   - Charts (Recharts): Set `isAnimationActive={false}` on ALL chart components (CRITICAL -- without this, Puppeteer captures mid-animation blanks)
   - Fixed container widths (no responsive breakpoints)
4. Wrap in `<PrintLayout>` with correct title
5. Set `data-print-ready="true"` on root element ONLY after data has loaded and component has rendered

**PrintExecutiveSummary.tsx:**
- KPI cards in a 2x4 or 3-column grid (print-friendly)
- Net Profit trend chart (isAnimationActive={false})
- Revenue by Category chart (isAnimationActive={false})
- Regional Performance chart (isAnimationActive={false})
- All data tables (project summary, lead sources, revenue by region, team performance)

**PrintFinancial.tsx:**
- P&L table (the main financial_weekly data)
- Revenue breakdown chart (isAnimationActive={false})
- Cost analysis chart (isAnimationActive={false})
- Cash position table

**PrintRegional.tsx:**
- 9-team comparison table (full width, landscape-optimised)
- Regional trend chart (isAnimationActive={false})

**PrintTargets.tsx:**
- Target list table grouped by type
- Target values with effective dates

**Key rules:**
- Every Recharts component MUST have `isAnimationActive={false}`
- Use fixed pixel widths for chart containers (e.g., `width={1100}` for landscape, `width={700}` for portrait)
- No loading skeletons -- show nothing until data is loaded, then set data-print-ready
- No buttons, toggles, or interactive elements
- Readable font sizes (min 10px for tables, 12px for body text)
- Australian date format throughout
  </action>
  <verify>
    - `cd client && npx tsc --noEmit` compiles without errors
    - Visit `http://localhost:4200/#/print/executive-summary?week=2025-01-25` in browser -- print page renders with data (or empty state if no data for that week)
    - Verify `data-print-ready="true"` attribute appears on root element after load (inspect in DevTools)
    - Visit `http://localhost:4200/#/print/financial?week=2025-01-25` -- renders financial print page
    - Normal app at `http://localhost:4200` still works (no print mode)
  </verify>
  <done>
    - Print-optimised page variants for all 4 dashboard pages
    - Hash-based routing in App.tsx detects print mode
    - PrintLayout wrapper provides consistent branding header
    - All Recharts components have animations disabled
    - data-print-ready attribute signals Puppeteer when page is ready
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full PDF export pipeline: Puppeteer service on server, print-optimised pages on client, API route, and PDF download button on all dashboard pages (from Plan 03-01).
  </what-built>
  <how-to-verify>
    1. Start both dev servers: `npm run dev`
    2. Navigate to Executive Summary page
    3. Click the PDF export button -- should download a PDF file
    4. Open the PDF and verify:
       - Buildable branding in header
       - Page title and week ending displayed
       - Charts render (not blank)
       - Tables have data
       - Portrait orientation
    5. Navigate to Financial Deep Dive, click PDF -- verify landscape orientation
    6. Navigate to Regional Performance, click PDF -- verify landscape orientation
    7. Navigate to Target Management, click PDF -- verify portrait orientation
    8. Check print routes directly: visit http://localhost:4200/#/print/executive-summary?week=2025-01-25 and verify it renders a clean print page
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Server compiles: `cd server && npx tsc --noEmit` (pre-existing warnings only)
2. Client compiles: `cd client && npx tsc --noEmit`
3. PDF endpoint responds: `curl -I http://localhost:6001/api/v1/exports/pdf/executive-summary?week=2025-01-25` returns Content-Type: application/pdf
4. Print routes render: All 4 print URLs load in browser with data-print-ready attribute
5. End-to-end: PDF downloads from each dashboard page produce valid PDF files
</verification>

<success_criteria>
- EXPRT-02 satisfied: Branded PDF snapshot of each dashboard page
- EXPRT-03 satisfied: PDF includes branding, page title, selected week, generation timestamp, charts and tables
- EXPRT-04 satisfied: Landscape for Financial and Regional, portrait for Executive Summary and Targets
- EXPRT-05 satisfied: Print-optimised layout with clean spacing, no interactive elements
</success_criteria>

<output>
After completion, create `.planning/phases/03-export-xero-integration/03-02-SUMMARY.md`
</output>
