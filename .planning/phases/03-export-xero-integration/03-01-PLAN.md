---
phase: 03-export-xero-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/lib/csvExport.ts
  - client/src/lib/exportApi.ts
  - client/src/components/ui/ExportButtons.tsx
  - client/src/components/dashboard/ExecutiveSummary.tsx
  - client/src/components/dashboard/FinancialDeepDive.tsx
  - client/src/components/dashboard/RegionalPerformance.tsx
  - client/src/components/targets/TargetManagement.tsx
autonomous: true

must_haves:
  truths:
    - "Every data table on Executive Summary, Financial, Regional, and Target Management pages has a working CSV download button"
    - "Downloaded CSV files open correctly in Excel with Australian date format (DD/MM/YYYY) and plain numeric currency values"
    - "CSV files include UTF-8 BOM so Excel recognises special characters and AUD symbols"
    - "PDF button exists on each page and calls the export API (returns loading/error state; actual PDF generation is Plan 03-02)"
  artifacts:
    - path: "client/src/lib/csvExport.ts"
      provides: "Client-side CSV generation utility with AU date/currency/pct formatters"
      exports: ["downloadCsv", "AUD_FORMATTER", "DATE_FORMATTER_AU", "PCT_FORMATTER"]
    - path: "client/src/lib/exportApi.ts"
      provides: "API client for PDF export endpoint"
      exports: ["downloadPdf"]
    - path: "client/src/components/ui/ExportButtons.tsx"
      provides: "Enhanced export buttons with real CSV + PDF handlers"
      contains: "onCsvExport"
  key_links:
    - from: "client/src/components/ui/ExportButtons.tsx"
      to: "client/src/lib/exportApi.ts"
      via: "downloadPdf() call on PDF button click"
      pattern: "downloadPdf"
    - from: "client/src/components/dashboard/ExecutiveSummary.tsx"
      to: "client/src/lib/csvExport.ts"
      via: "downloadCsv() called from ExportButtons onCsvExport prop"
      pattern: "downloadCsv"
---

<objective>
Create the CSV export system: a client-side CSV generation utility, enhanced ExportButtons component with real handlers, and integration into all four dashboard pages. Also wire the PDF button to call the export API (actual PDF generation is Plan 03-02).

Purpose: Directors need to download dashboard data as spreadsheets for offline analysis and reporting. This is the most user-visible export feature.
Output: Working CSV downloads from every data table, PDF button wired (pending server-side PDF in Plan 03-02).
</objective>

<execution_context>
@C:/Users/Dev180D/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dev180D/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-export-xero-integration/03-RESEARCH.md

Key codebase files:
@client/src/components/ui/ExportButtons.tsx
@client/src/components/dashboard/ExecutiveSummary.tsx
@client/src/components/dashboard/FinancialDeepDive.tsx
@client/src/components/dashboard/RegionalPerformance.tsx
@client/src/components/targets/TargetManagement.tsx
@client/src/lib/dashboardApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export utility and export API client</name>
  <files>
    client/src/lib/csvExport.ts
    client/src/lib/exportApi.ts
  </files>
  <action>
**IMPORTANT:** PapaParse is NOT installed on the client (only on server). Do NOT use Papa.unparse(). Instead, build a lightweight RFC 4180-compliant CSV generator.

**Create `client/src/lib/csvExport.ts`:**

```typescript
// CSV column definition
export interface CsvColumn<T = any> {
  key: string;
  label: string;
  format?: (value: any, row: T) => string;
}

// Formatters for Australian conventions
export const AUD_FORMATTER = (val: number | null) =>
  val != null ? val.toFixed(2) : '';

export const DATE_FORMATTER_AU = (val: string | null) => {
  if (!val) return '';
  const d = new Date(val + (val.includes('T') ? '' : 'T00:00:00'));
  return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
};

export const PCT_FORMATTER = (val: number | null) =>
  val != null ? `${val.toFixed(1)}%` : '';

export const NUM_FORMATTER = (val: number | null) =>
  val != null ? String(val) : '';
```

The `downloadCsv<T>()` function should:
1. Accept `filename: string`, `columns: CsvColumn<T>[]`, `data: T[]`
2. Build header row from column labels
3. Build data rows by mapping each row through columns, applying formatters
4. Escape values per RFC 4180: wrap in double quotes if value contains comma, double quote, or newline; escape double quotes by doubling them
5. Join with `\r\n` line endings
6. Prepend UTF-8 BOM (`\uFEFF`) for Excel compatibility
7. Create Blob with type `text/csv;charset=utf-8;`
8. Trigger download using anchor element (createElement, set href to URL.createObjectURL, set download attribute, click, cleanup with revokeObjectURL)
9. Ensure filename ends with `.csv`

**Create `client/src/lib/exportApi.ts`:**

```typescript
export async function downloadPdf(pageSlug: string, weekEnding: string): Promise<void> {
  const res = await fetch(`/api/v1/exports/pdf/${pageSlug}?week=${weekEnding}`);
  if (!res.ok) {
    const body = await res.json().catch(() => ({}));
    throw new Error(body?.error ?? `PDF export failed: ${res.status}`);
  }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${pageSlug}-${weekEnding}.pdf`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
```

This calls the PDF export API endpoint (built in Plan 03-02). For now it will return 404 until the server route exists, which is expected.
  </action>
  <verify>
    - `npx tsc --noEmit` in client directory compiles without errors related to these files
    - Both files export the documented functions and types
  </verify>
  <done>
    - csvExport.ts exports downloadCsv, CsvColumn, AUD_FORMATTER, DATE_FORMATTER_AU, PCT_FORMATTER, NUM_FORMATTER
    - exportApi.ts exports downloadPdf
    - CSV generation handles RFC 4180 escaping, UTF-8 BOM, Australian date format
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance ExportButtons and integrate into all dashboard pages</name>
  <files>
    client/src/components/ui/ExportButtons.tsx
    client/src/components/dashboard/ExecutiveSummary.tsx
    client/src/components/dashboard/FinancialDeepDive.tsx
    client/src/components/dashboard/RegionalPerformance.tsx
    client/src/components/targets/TargetManagement.tsx
  </files>
  <action>
**Enhance `ExportButtons.tsx`:**

Replace the stub component with a fully functional version:

Props interface:
```typescript
interface ExportButtonsProps {
  disabled?: boolean;
  onCsvExport: () => void;          // Called when CSV button clicked
  pageSlug: string;                  // e.g. 'executive-summary', 'financial'
  weekEnding: string;                // ISO date string for PDF filename
}
```

- CSV button: calls `onCsvExport()` prop directly (parent component owns the data and column definitions)
- PDF button: calls `downloadPdf(pageSlug, weekEnding)` from `exportApi.ts`. Wrap in try/catch, show loading state on the button (spinner icon or "Exporting..." text), and show an alert on error. Use `useState` for `pdfLoading` and `pdfError`.
- Keep existing Tailwind styling (gray-50 bg, gray-200 border, xs font). Add a subtle loading spinner to PDF button when loading.
- If `pdfError`, show brief error tooltip or change button border to error red temporarily.

**Integrate into ExecutiveSummary.tsx:**

1. Import `ExportButtons` and `downloadCsv`, `CsvColumn`, `AUD_FORMATTER`, `DATE_FORMATTER_AU`, `PCT_FORMATTER` from csvExport.
2. Import `useWeek` (already there).
3. Add ExportButtons in the page header area (top right of the first section or next to the page title).
4. Define CSV export handler that exports **all four data tables** present on Executive Summary:
   - **Project summary table** (type, count, invoiced, budget, variance columns)
   - **Lead source table** (source, count columns)
   - **Revenue by region table** (region, actual, target, variance columns)
   - **Team performance table** (team, revenue, staff cost, ratio columns)

   The handler should call `downloadCsv()` with the relevant data. If the page has multiple tables, export the primary/most comprehensive table (project summary or revenue by region). If there are multiple distinct datasets, create a combined export or export the most important one. Examine the actual data structure in `ExecutiveSummaryData` from `dashboardApi.ts` to determine exact column definitions.

5. Pass `pageSlug="executive-summary"` and `weekEnding={selectedWeek}` for PDF.

**Integrate into FinancialDeepDive.tsx:**

1. Same pattern: import ExportButtons and CSV utilities.
2. Place ExportButtons in page header.
3. Define CSV handler exporting the P&L data table (the main financial weekly data). Look at the component to determine which data tables exist and export the primary one. Use AUD_FORMATTER for currency columns, DATE_FORMATTER_AU for dates.
4. Pass `pageSlug="financial"` and `weekEnding={selectedWeek}`.

**Integrate into RegionalPerformance.tsx:**

1. Same pattern.
2. Export the regional comparison table (9 teams, with revenue/target/variance per team).
3. Pass `pageSlug="regional"` and `weekEnding={selectedWeek}`.

**Integrate into TargetManagement.tsx:**

1. Same pattern.
2. Export the target list (target type, value, effective from, effective to).
3. Pass `pageSlug="targets"` and `weekEnding={selectedWeek}`.

**Key rules:**
- Currency values in CSV should be plain numbers (e.g., `1234.56` not `$1,234.56`) so Excel can format them. Use AUD_FORMATTER which outputs `toFixed(2)`.
- Dates should use DD/MM/YYYY Australian format via DATE_FORMATTER_AU.
- Percentages should use PCT_FORMATTER (e.g., `65.2%`).
- Column headers should be human-readable Australian English (e.g., "Week Ending", "Net Profit ($)", "Revenue to Staff Ratio (%)").
- If data is null/loading, the CSV button should be disabled (pass `disabled={!data}` or similar).
  </action>
  <verify>
    - `cd client && npx tsc --noEmit` compiles without errors
    - Run `npm run dev` (client), navigate to each dashboard page, verify ExportButtons component renders
    - Click CSV button on Executive Summary -- a .csv file downloads
    - Open downloaded CSV in a text editor -- verify UTF-8 BOM, header row, Australian date format, plain numeric currency
  </verify>
  <done>
    - ExportButtons component on all 4 dashboard pages (Executive Summary, Financial, Regional, Targets)
    - CSV download works on all pages with correct Australian formatting
    - PDF button shows loading state and calls export API (will 404 until Plan 03-02)
    - CSV button disabled when page data is loading or empty
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd client && npx tsc --noEmit` passes
2. Visual: Each of the 4 dashboard pages shows Export buttons (CSV + PDF) in the header area
3. Functional: Clicking CSV on any page downloads a .csv file
4. Data quality: Open CSV in text editor -- first 3 bytes are BOM (EF BB BF), headers are human-readable, dates are DD/MM/YYYY, currency is plain numbers
5. PDF button clicks without crash (shows loading briefly, then error since endpoint doesn't exist yet)
</verification>

<success_criteria>
- EXPRT-01 satisfied: CSV download button on every data table across all dashboard pages
- CSV files are correctly formatted with Australian conventions
- ExportButtons is a reusable component with onCsvExport callback and built-in PDF download
- All four dashboard pages have export functionality integrated
</success_criteria>

<output>
After completion, create `.planning/phases/03-export-xero-integration/03-01-SUMMARY.md`
</output>
