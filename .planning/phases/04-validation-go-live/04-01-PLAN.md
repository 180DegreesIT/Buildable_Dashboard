---
phase: 04-validation-go-live
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/scripts/extract-reference.ts
  - server/src/data/reference-values.json
  - server/src/services/ValidationService.ts
  - server/src/routes/validation.ts
  - server/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Reference extraction script reads the Excel workbook and outputs expected values for 3-4 checkpoint weeks"
    - "ValidationService queries dashboard API endpoints and compares response values against reference JSON"
    - "Validation results show pass/fail per check with expected vs actual values and a summary score"
    - "GET /api/v1/validation/run returns structured validation results for terminal AND dashboard consumption"
  artifacts:
    - path: "server/src/scripts/extract-reference.ts"
      provides: "One-time ExcelJS script to extract reference values from workbook"
      min_lines: 100
    - path: "server/src/data/reference-values.json"
      provides: "Expected values per checkpoint week for all migrated tables"
      contains: "financial"
    - path: "server/src/services/ValidationService.ts"
      provides: "Core validation logic comparing API responses to reference values"
      exports: ["ValidationService"]
      min_lines: 150
    - path: "server/src/routes/validation.ts"
      provides: "API route exposing validation results"
      min_lines: 30
  key_links:
    - from: "server/src/services/ValidationService.ts"
      to: "/api/v1/dashboard/executive-summary"
      via: "HTTP fetch to own API"
      pattern: "fetch.*executive-summary"
    - from: "server/src/routes/validation.ts"
      to: "server/src/services/ValidationService.ts"
      via: "import and call"
      pattern: "ValidationService"
    - from: "server/src/scripts/extract-reference.ts"
      to: "server/src/data/reference-values.json"
      via: "writeFileSync output"
      pattern: "writeFileSync"
---

<objective>
Extract reference values from the Excel workbook using ExcelJS, build a ValidationService that queries the dashboard API endpoints and compares database values against the reference JSON, and expose the results via an API route.

Purpose: Provide the data verification backbone for Phase 4 -- without accurate reference values and a comparison engine, no validation can occur.
Output: A reference-values.json file with expected data for 3-4 checkpoint weeks, a ValidationService that runs all checks, and an API endpoint returning structured results.
</objective>

<execution_context>
@C:/Users/Dev180D/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dev180D/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation-go-live/04-CONTEXT.md
@.planning/phases/04-validation-go-live/04-RESEARCH.md

# Key existing infrastructure
@server/src/services/ExcelParserService.ts — extractCell(), extractNumericValue(), cellRef() utilities
@server/src/services/SheetParsers/WeeklyReportParser.ts — knows exact row numbers for financial/projects/leads data
@server/src/services/SheetParsers/FinanceThisWeekParser.ts — knows cell positions for cash position
@server/src/services/SheetParsers/RevenueReportParser.ts — revenue category row mappings
@server/src/services/FinancialService.ts — computeDerivedMetrics() for grossProfitMargin, revenueToStaffRatio
@server/src/services/WeekService.ts — toSaturday() date snapping
@server/src/routes/dashboard.ts — executive-summary, financial-deep-dive, regional-performance endpoint structures
@server/src/routes/marketing.ts — /leads endpoint structure
@server/src/routes/teams.ts — /performance endpoint structure
@server/prisma/schema.prisma — all table definitions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build reference value extraction script</name>
  <files>
    server/src/scripts/extract-reference.ts
    server/src/data/reference-values.json
  </files>
  <action>
Create a TypeScript script that reads the Excel workbook (Weekly_Report__30.xlsx or path from CLI arg) using ExcelJS and extracts expected values for 3-4 checkpoint weeks (auto-detect available weeks from date row, pick early/middle/late + week 30).

**Reuse existing infrastructure:**
- Import extractCell() and extractNumericValue() from ExcelParserService
- Import WeekService.toSaturday() for date normalisation
- Reference WeeklyReportParser for row numbers (financial fields at specific rows, team performance rows, leads rows)
- Reference FinanceThisWeekParser for cash position cell positions
- Reference RevenueReportParser for revenue category row mappings

**Reference JSON structure:**
```typescript
interface ReferenceData {
  extractedAt: string; // ISO timestamp
  workbookPath: string;
  checkpointWeeks: Array<{
    weekEnding: string; // YYYY-MM-DD (Saturday)
    weekNumber: number; // Column index in workbook
    financial: {
      totalTradingIncome: number;
      totalCostOfSales: number;
      grossProfit: number;
      otherIncome: number;
      operatingExpenses: number;
      wagesAndSalaries: number;
      netProfit: number;
    };
    teams: Array<{
      region: string; // enum value e.g. 'cairns'
      actualInvoiced: number;
    }>;
    leads: Array<{
      source: string; // enum value e.g. 'google'
      leadCount: number;
    }>;
    cashPosition: {
      everydayAccount: number;
      totalCashAvailable: number;
      totalReceivables: number;
    };
    googleReviews: {
      reviewCount: number;
      cumulativeCount: number;
    };
  }>;
}
```

The script should:
1. Accept workbook path as CLI argument (default: `./Weekly_Report__30.xlsx`)
2. Open workbook with ExcelJS
3. Detect all available week columns from date row in "Weekly Report" sheet
4. Select 3-4 checkpoint weeks: earliest available, a middle week, week 30 (latest), and one ~week 20
5. For each checkpoint week, extract values from all relevant sheets using the same row mappings as the migration parsers
6. Write the result to `server/src/data/reference-values.json`
7. Print a summary to console showing which weeks were extracted and how many values per section

**Run the script** using `npx tsx server/src/scripts/extract-reference.ts` (or the workbook path if different). The script must work on Windows paths.

**Important:** Use the same cell extraction logic as the migration parsers. If the parsers read row 15 for netProfit in WeeklyReportParser, this script reads row 15 for netProfit. This ensures apples-to-apples comparison.
  </action>
  <verify>
1. `npx tsx server/src/scripts/extract-reference.ts [workbook-path]` runs without errors
2. `server/src/data/reference-values.json` exists and contains 3-4 checkpoint weeks
3. Week 30 reference values include netProfit close to $62,210.45 (known from roadmap)
4. Each checkpoint week has financial, teams, leads, cashPosition, and googleReviews sections
  </verify>
  <done>
Reference JSON file exists with extracted values for 3-4 checkpoint weeks. Week 30 values are present and include the known reference values from the roadmap. The script is repeatable (running again produces identical output from the same workbook).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ValidationService with API-level comparison</name>
  <files>
    server/src/services/ValidationService.ts
  </files>
  <action>
Create ValidationService that loads reference-values.json and compares against live API responses.

**Pattern: API-level comparison (not raw DB).**
The service calls the same endpoints the dashboard uses, testing the full stack including derived metrics computation.

**Structure:**
```typescript
interface ValidationCheck {
  id: string;           // e.g. 'week30.financial.netProfit'
  category: string;     // e.g. 'Financial', 'Team Performance', 'Leads'
  weekEnding: string;
  field: string;
  expected: number;
  actual: number | null;
  difference: number;
  passed: boolean;
  note?: string;        // e.g. 'Value missing from database'
}

interface ValidationResult {
  runAt: string;
  duration: number; // ms
  totalChecks: number;
  passed: number;
  failed: number;
  checks: ValidationCheck[];
  summary: {
    byCategory: Record<string, { passed: number; failed: number; total: number }>;
    byWeek: Record<string, { passed: number; failed: number; total: number }>;
  };
}
```

**Comparison logic:**
- Currency values: Compare using `Math.round(val * 100) === Math.round(expected * 100)` (exact to the cent)
- Integer values (lead counts, review counts): Exact match
- Null actual when expected exists: Mark as failed with note "Value missing from database"
- Expected 0 and actual 0: Pass

**API endpoints to call (using http://localhost:6001):**
1. `GET /api/v1/dashboard/executive-summary?weekEnding={date}` -- financial KPIs, team performance, lead breakdown
2. `GET /api/v1/dashboard/financial-deep-dive?weekEnding={date}` -- P&L details, cash position
3. `GET /api/v1/dashboard/regional-performance?weekEnding={date}` -- team actuals vs targets
4. `GET /api/v1/marketing/leads?weekEnding={date}` -- lead source breakdown
5. `GET /api/v1/teams/performance?weekEnding={date}` -- team performance with targets

For each checkpoint week in the reference JSON:
- Fetch executive summary: compare netProfit, totalTradingIncome, grossProfit, wagesAndSalaries, totalLeads, leadBreakdown per source, teamPerformance per region
- Fetch financial deep dive: compare plWeekly fields, cashPosition fields
- Fetch leads: compare per-source leadCount

**Console output:**
Print results to console with colour coding (green pass, red fail) using ANSI escape codes.
Format: `[PASS] week30.financial.netProfit: expected $62,210.45, actual $62,210.45`
Summary at end: `47/50 checks passed (94%)`

**Error handling:**
- If API returns 500 or no data, mark all checks for that week/endpoint as failed with note
- If reference-values.json doesn't exist, throw clear error: "Run extract-reference.ts first"
- Timeout after 10 seconds per API call
  </action>
  <verify>
1. TypeScript compiles without errors
2. ValidationService exports `runValidation()` method returning `ValidationResult`
3. Handles missing API data gracefully (doesn't crash on empty database)
  </verify>
  <done>
ValidationService loads reference JSON, calls all dashboard API endpoints for each checkpoint week, compares every field to expected values exact to the cent, and returns structured results with pass/fail counts and category/week summaries. Console output shows coloured results.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create validation API route and register in server</name>
  <files>
    server/src/routes/validation.ts
    server/src/index.ts
  </files>
  <action>
Create a validation route that exposes the ValidationService via the API, and register it in the server.

**Route: `server/src/routes/validation.ts`**
```typescript
// GET /run — Execute full validation suite and return results
// Response: ValidationResult object (same structure as service returns)
// Also prints results to server console for terminal visibility

// GET /reference — Return the reference values JSON (for debugging)
```

The /run endpoint should:
1. Call ValidationService.runValidation()
2. Print summary to server console (terminal output)
3. Return the full ValidationResult as JSON response

The /reference endpoint should:
1. Read and return reference-values.json directly
2. Return 404 if file doesn't exist

**Register in `server/src/index.ts`:**
Add `import validationRoutes from './routes/validation.js';` and `app.use('/api/v1/validation', validationRoutes);` in the same pattern as existing routes. Place it after the existing route registrations.

**No auth required for validation routes** (dev tool, not user-facing in production). But still place it after the authenticate middleware line since the same pattern is used throughout.

**Important:** The validation route must work when the server is already running -- it calls its own API endpoints via localhost. Use the SERVER_PORT env var (default 6001) to construct the base URL for internal API calls in the ValidationService.
  </action>
  <verify>
1. `curl http://localhost:6001/api/v1/validation/run` returns JSON with validation results
2. `curl http://localhost:6001/api/v1/validation/reference` returns the reference values JSON
3. Server console shows coloured validation output when /run is called
4. Server compiles and starts without errors after adding the new route
  </verify>
  <done>
Validation API route is registered and working. GET /run executes the full validation suite with dual output (JSON response + terminal console). GET /reference returns raw reference data for debugging.
  </done>
</task>

</tasks>

<verification>
1. Reference extraction script runs successfully on the workbook and produces reference-values.json
2. Starting the server with `npm run dev` works without compilation errors
3. `curl http://localhost:6001/api/v1/validation/run` returns structured validation results
4. Server console shows validation summary with pass/fail counts
5. `curl http://localhost:6001/api/v1/validation/reference` returns the checkpoint week data
6. Week 30 financial values in reference match known roadmap values (Net Profit ~$62,210.45)
</verification>

<success_criteria>
- reference-values.json contains 3-4 checkpoint weeks with financial, team, leads, cash, and reviews data
- ValidationService compares all fields across all checkpoint weeks against live API responses
- Currency comparisons are exact to the cent (no floating point tolerance beyond cent rounding)
- API route returns structured results suitable for both terminal and UI consumption
- Summary score format: "X/Y checks passed (Z%)"
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-go-live/04-01-SUMMARY.md`
</output>
