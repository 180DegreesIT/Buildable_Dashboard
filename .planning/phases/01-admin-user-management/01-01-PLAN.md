---
phase: 01-admin-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/routes/settings.ts
  - server/src/services/SettingsService.ts
  - server/src/index.ts
  - server/src/middleware/permissions.ts
  - client/src/lib/settingsApi.ts
  - client/src/lib/SettingsContext.tsx
  - client/src/components/admin/AdminSettings.tsx
  - client/src/components/admin/BrandingSection.tsx
  - client/src/components/admin/PassThroughSection.tsx
  - client/src/components/admin/AlertThresholds.tsx
  - client/src/components/admin/SystemStatus.tsx
  - client/src/App.tsx
  - client/src/components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can upload a company logo, set company name, and choose accent colours -- changes appear immediately in the app header and sidebar"
    - "Admin can add/remove pass-through items from a tag list, and those items are stored in the database for the Net Revenue toggle"
    - "Admin can configure alert thresholds (net profit, team performance, cash position) with warning and critical levels"
    - "System status section shows greyed-out placeholder cards for Xero, 3CX, and Reportei with 'Not Connected' badges"
    - "Branding settings load globally via SettingsContext -- sidebar shows logo/company name, no per-component fetching"
    - "Permission middleware no longer makes N+1 DB queries (uses cached permissions from req.user)"
  artifacts:
    - path: "server/src/routes/settings.ts"
      provides: "Settings CRUD API endpoints"
      exports: ["default (Router)"]
    - path: "server/src/services/SettingsService.ts"
      provides: "Settings business logic and logo file handling"
      exports: ["SettingsService"]
    - path: "client/src/lib/SettingsContext.tsx"
      provides: "Global settings context provider with branding, alerts, pass-through"
      exports: ["SettingsProvider", "useSettings"]
    - path: "client/src/components/admin/AdminSettings.tsx"
      provides: "Main admin settings page with all sections"
      exports: ["default"]
    - path: "client/src/lib/settingsApi.ts"
      provides: "Settings API client functions"
      exports: ["fetchSettings", "updateBranding", "uploadLogo", "updatePassThrough", "updateAlertThresholds"]
  key_links:
    - from: "client/src/components/admin/BrandingSection.tsx"
      to: "/api/v1/settings/branding"
      via: "settingsApi.updateBranding + settingsApi.uploadLogo"
      pattern: "updateBranding|uploadLogo"
    - from: "client/src/lib/SettingsContext.tsx"
      to: "/api/v1/settings"
      via: "fetch in useEffect on mount"
      pattern: "fetch.*api/v1/settings"
    - from: "client/src/components/layout/Sidebar.tsx"
      to: "SettingsContext"
      via: "useSettings() hook for logo and company name"
      pattern: "useSettings"
    - from: "server/src/middleware/permissions.ts"
      to: "req.user.permissions"
      via: "check cached permissions array before DB query"
      pattern: "user\\.permissions|req\\.user"
---

<objective>
Build the Admin Settings backend API and frontend page, including branding configuration (logo upload, company name, colours), pass-through items management, alert threshold configuration, and system status placeholder cards. Also create the SettingsContext for global branding consumption and fix the N+1 permission middleware query.

Purpose: Gives administrators a control panel to configure system appearance and business rules. The SettingsContext provides branding data to the sidebar/header immediately, making the dashboard feel like Buildable's own tool. Fixing the N+1 permission query addresses a known performance concern.

Output: Working Admin Settings page at `/admin_settings` with all four sections (Branding, Pass-Through Items, Alert Thresholds, System Status), global branding via SettingsContext, and optimised permission middleware.
</objective>

<execution_context>
@C:/Users/Dev180D/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dev180D/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-admin-user-management/01-CONTEXT.md
@.planning/phases/01-admin-user-management/01-RESEARCH.md

Key existing files to reference:
@server/src/routes/targets.ts — Route pattern (Router + Zod + validateBody + try/catch/next)
@server/src/middleware/validation.ts — validateBody/validateQuery middleware
@server/src/middleware/permissions.ts — Permission middleware to fix N+1 query
@server/src/middleware/auth.ts — Auth middleware (getUserWithPermissions already includes permissions)
@server/src/services/AuthService.ts — AuthService pattern (static methods, prisma usage)
@server/src/index.ts — Route registration pattern
@server/src/routes/dashboard.ts — Lines 300-307 show existing pass_through_categories usage
@client/src/lib/WeekContext.tsx — Context provider pattern to follow
@client/src/lib/api.ts — API client pattern (request helper + typed functions)
@client/src/App.tsx — Page routing and provider wrapping
@client/src/components/layout/Sidebar.tsx — Sidebar to add branding (logo, company name)
@client/src/components/layout/TopBar.tsx — TopBar for potential branding accent colour
@server/prisma/schema.prisma — Setting model (key/value JSON), User model, DashboardPage enum
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings backend API, logo upload, and permission middleware fix</name>
  <files>
    server/src/routes/settings.ts
    server/src/services/SettingsService.ts
    server/src/index.ts
    server/src/middleware/permissions.ts
  </files>
  <action>
**1. Create `server/src/services/SettingsService.ts`:**
- Static class following the AuthService pattern
- `getAll()`: Fetch all settings from prisma.setting.findMany(), return as `Record<string, any>` keyed by setting.key
- `get(key: string)`: Fetch single setting by key
- `upsert(key: string, value: any)`: Prisma upsert on the Setting model. For JSON merge safety, read existing value first, spread with new value, then upsert. This prevents race conditions where updating company name overwrites logoPath.
- `uploadLogo(buffer: Buffer, originalName: string)`: Save file to `server/uploads/` directory. Use `crypto.randomUUID()` for unique filename. Delete old logo file if one exists (read current branding setting to find old path). Return the URL path `/api/uploads/{filename}`. Create the uploads directory on first call using `fs.mkdir(recursive: true)`. Use `path.join()` for filesystem operations, forward slashes for URL paths. Validate image type (png, jpeg, svg+xml, webp) and max 2MB size in the Multer config, not in this method.
- `deleteLogo()`: Remove logo file from disk if it exists, update branding setting to set logoPath to null

**2. Create `server/src/routes/settings.ts`:**
Follow the exact pattern from targets.ts (Router, Zod schemas, validateBody, try/catch with next).

Endpoints:
- `GET /` — Fetch all settings. No permission check needed (any authenticated user needs branding for the header). Returns `Record<string, any>`.
- `GET /:key` — Fetch single setting by key. No permission check (same reason).
- `PUT /branding` — Update branding text fields. Requires `requirePermission('admin_settings', 'write')`. Zod schema: `{ companyName: z.string().min(1).max(100), primaryColour: z.string().regex(/^#[0-9A-Fa-f]{6}$/), accentColour: z.string().regex(/^#[0-9A-Fa-f]{6}$/) }`. Calls SettingsService.upsert('branding', ...) merging with existing value (preserves logoPath).
- `POST /branding/logo` — Upload logo. Requires `requirePermission('admin_settings', 'write')`. Use Multer with `memoryStorage()`, fileFilter for image types, 2MB limit. Call `SettingsService.uploadLogo()`. Return `{ logoPath: string }`.
- `DELETE /branding/logo` — Remove logo. Requires admin write. Calls `SettingsService.deleteLogo()`.
- `PUT /pass-through-categories` — Update pass-through items. Requires admin write. Zod: `{ categories: z.array(z.string().min(1)).max(20) }`. Calls SettingsService.upsert('pass_through_categories', data.categories).
- `PUT /alert-thresholds` — Update alert thresholds. Requires admin write. Zod schema for array of `{ metric: z.string(), label: z.string(), direction: z.enum(['below', 'above']), warningValue: z.number(), criticalValue: z.number(), unit: z.enum(['currency', 'percentage']) }`. Calls SettingsService.upsert('alert_thresholds', data.thresholds).

**3. Update `server/src/index.ts`:**
- Add `import settingsRoutes from './routes/settings.js';`
- Add `app.use('/api/uploads', express.static(path.join(import.meta.dirname ?? __dirname, '..', 'uploads')));` BEFORE the auth middleware line (uploads should be served without auth for logo display). Import `path` from 'path'. Use `import.meta.dirname` for ESM or `__dirname` for CJS -- check the existing module system (the codebase uses `.js` extensions in imports suggesting ESM). If ESM, use `fileURLToPath` + `dirname` from 'url' and 'path' to get __dirname equivalent, or use the approach already used elsewhere in the codebase.
- Add `app.use('/api/v1/settings', settingsRoutes);` after the authenticate middleware line, alongside the other route registrations.

**4. Fix N+1 query in `server/src/middleware/permissions.ts`:**
- The `resolvePermission` function currently takes `(userId, role, page)` and queries `prisma.userPermission.findUnique` on every call.
- In production, `auth.ts` calls `AuthService.getUserWithPermissions(payload.userId)` which does `include: { permissions: true }` -- so `req.user` already has `permissions` array loaded.
- In dev mode, `AuthService.getDevUser()` does NOT include permissions. Fix `getDevUser()` in `server/src/services/AuthService.ts` to add `include: { permissions: true }` to the upsert's return (use a follow-up findUnique with include, since upsert doesn't reliably return relations in all Prisma versions, OR chain with `prisma.user.findUnique({ where: { email }, include: { permissions: true } })` after the upsert).
- Modify `resolvePermission` to accept an optional `permissions` array parameter: `resolvePermission(userId, role, page, permissions?: UserPermission[])`. If `permissions` is provided, search it in-memory with `.find(p => p.page === page)` instead of querying the DB. Only fall back to DB query if permissions array is not provided.
- Modify `requirePermission` middleware to pass `(req.user as any)?.permissions` to `resolvePermission`. The User type from Prisma doesn't include the permissions relation by default, so cast or use optional chaining.
- This eliminates the per-route DB query when permissions are already loaded.
  </action>
  <verify>
1. `cd C:/Projects/buildable_dashboard/server && npx tsc --noEmit` — TypeScript compiles without new errors (pre-existing Prisma import errors are acceptable)
2. Start the dev server and test with curl:
   - `curl http://localhost:6001/api/v1/settings` — returns `{}` or existing settings (200)
   - `curl -X PUT http://localhost:6001/api/v1/settings/branding -H "Content-Type: application/json" -d '{"companyName":"Buildable Test","primaryColour":"#4573D2","accentColour":"#E8A442"}'` — returns updated setting (200)
   - `curl http://localhost:6001/api/v1/settings/branding` — returns the saved branding object
   - `curl -X PUT http://localhost:6001/api/v1/settings/pass-through-categories -H "Content-Type: application/json" -d '{"categories":["council_fees","insurance_levy"]}'` — returns 200
   - `curl -X PUT http://localhost:6001/api/v1/settings/alert-thresholds -H "Content-Type: application/json" -d '{"thresholds":[{"metric":"net_profit","label":"Net Profit","direction":"below","warningValue":80,"criticalValue":50,"unit":"percentage"}]}'` — returns 200
3. Verify uploads directory was created: `ls C:/Projects/buildable_dashboard/server/uploads/`
  </verify>
  <done>
- All 6 settings endpoints respond correctly (GET all, GET by key, PUT branding, POST logo, DELETE logo, PUT pass-through, PUT thresholds)
- Logo upload saves file to server/uploads/ and returns accessible URL path
- Permission middleware uses cached permissions from req.user when available (no DB query per route)
- express.static serves uploaded files at /api/uploads/
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin Settings frontend — SettingsContext, all sections, and branding integration</name>
  <files>
    client/src/lib/settingsApi.ts
    client/src/lib/SettingsContext.tsx
    client/src/components/admin/AdminSettings.tsx
    client/src/components/admin/BrandingSection.tsx
    client/src/components/admin/PassThroughSection.tsx
    client/src/components/admin/AlertThresholds.tsx
    client/src/components/admin/SystemStatus.tsx
    client/src/App.tsx
    client/src/components/layout/Sidebar.tsx
  </files>
  <action>
**1. Create `client/src/lib/settingsApi.ts`:**
Follow the pattern from `client/src/lib/api.ts` (request helper, typed functions). Base URL: `/api/v1/settings`.

Functions:
- `fetchAllSettings(): Promise<Record<string, any>>` — GET /api/v1/settings
- `updateBranding(data: { companyName: string; primaryColour: string; accentColour: string }): Promise<any>` — PUT /api/v1/settings/branding
- `uploadLogo(file: File): Promise<{ logoPath: string }>` — POST /api/v1/settings/branding/logo (FormData with 'logo' key)
- `deleteLogo(): Promise<void>` — DELETE /api/v1/settings/branding/logo
- `updatePassThroughCategories(categories: string[]): Promise<any>` — PUT /api/v1/settings/pass-through-categories
- `updateAlertThresholds(thresholds: AlertThreshold[]): Promise<any>` — PUT /api/v1/settings/alert-thresholds

Export the `AlertThreshold` interface: `{ metric: string; label: string; direction: 'below' | 'above'; warningValue: number; criticalValue: number; unit: 'currency' | 'percentage' }`

Export the `BrandingSettings` interface: `{ companyName: string; logoPath: string | null; primaryColour: string; accentColour: string }`

**2. Create `client/src/lib/SettingsContext.tsx`:**
Follow the WeekContext pattern exactly.

```
interface SettingsContextValue {
  branding: BrandingSettings;
  alertThresholds: AlertThreshold[];
  passThroughCategories: string[];
  loading: boolean;
  refreshSettings: () => Promise<void>;
}
```

Defaults: `companyName: 'Buildable'`, `logoPath: null`, `primaryColour: '#4573D2'`, `accentColour: '#4573D2'`, empty arrays for thresholds/passthrough.

On mount, call `fetchAllSettings()` and populate state from the result. Expose `refreshSettings` that re-fetches and updates state. Export `SettingsProvider` and `useSettings` hook.

**3. Update `client/src/App.tsx`:**
- Import `SettingsProvider` from `./lib/SettingsContext`
- Import `AdminSettings` from `./components/admin/AdminSettings`
- Wrap the existing `WeekProvider` inside `SettingsProvider` (SettingsProvider is the outermost provider since it doesn't depend on WeekContext)
- Replace the `admin_settings` PlaceholderPage with `<AdminSettings />`
- Keep the `user_management` PlaceholderPage as-is (Plan 02 will replace it)

**4. Create `client/src/components/admin/AdminSettings.tsx`:**
Main container page. Single scrollable page with vertically stacked card sections. Uses URL hash for section anchors (e.g., `#branding`, `#pass-through`, `#alerts`, `#status`).

Structure:
- Page title "Admin Settings" with subtitle
- `<BrandingSection />` with id="branding"
- `<PassThroughSection />` with id="pass-through"
- `<AlertThresholds />` with id="alerts"
- `<SystemStatus />` with id="status"
- 32px gap between sections (consistent with project design language)

Each section is wrapped in a white card (subtle shadow, 8px radius, 24px padding — matching existing card styles in the codebase).

**5. Create `client/src/components/admin/BrandingSection.tsx`:**
- Logo upload: drag-and-drop zone (onDragOver, onDrop handlers) with click fallback (hidden file input). Shows current logo as preview if one exists. "Remove" button to delete current logo. Accept image/png, image/jpeg, image/svg+xml, image/webp. Max 2MB (validate client-side before upload).
- Company name: text input with max 100 chars
- Primary colour: HTML `<input type="color">` picker with hex text input alongside. Preset swatches for the project's colour palette (#4573D2, #6AAF50, #E8A442, #D94F4F, #1A1A2E).
- Accent colour: same pattern as primary colour
- Live preview: show a mini preview of how the sidebar header would look with current selections (company name + logo + colours)
- Local form state — NO auto-save. Explicit "Save Changes" button. On save: if logo file selected, upload via `uploadLogo()` first, then call `updateBranding()` with text fields, then call `refreshSettings()` from SettingsContext so sidebar/header update immediately.
- Loading and success/error toast states (use a simple inline message or notification pattern consistent with the codebase)

**6. Create `client/src/components/admin/PassThroughSection.tsx`:**
- Tag-list pattern (per Claude's Discretion in CONTEXT.md — better for short lists)
- Text input with "Add" button. User types a category name and adds it.
- Current items shown as tag badges with X button to remove
- Available categories could come from the RevenueCategory values or be free-text. For simplicity, make it free-text input (the dashboard.ts code treats them as string matches against revenue category names).
- Local state array. "Save Changes" button calls `updatePassThroughCategories()` then `refreshSettings()`.
- Show a helper note: "Items listed here will be excluded when the Net Revenue toggle is active on Financial views."

**7. Create `client/src/components/admin/AlertThresholds.tsx`:**
- Display the 3 default metrics (Net Profit Below Budget, Team Revenue Performance, Cash Approaching Overdraft) as cards within this section
- Each metric card shows: label, direction indicator (below/above), range slider for warning level (amber zone), range slider for critical level (red zone), companion number input next to each slider for precise entry
- Colour zones on sliders: green (above warning), amber (between warning and critical), red (below critical). For "below" direction: red is left, green is right. For "above" direction: red is right, green is left.
- Unit display: show $ prefix for currency metrics, % suffix for percentage metrics
- Extensible design: render from array state so new metrics can be added later without restructuring
- Local state. "Save Changes" button calls `updateAlertThresholds()` then `refreshSettings()`.

**8. Create `client/src/components/admin/SystemStatus.tsx`:**
- Three greyed-out cards side by side (responsive: 3 columns on lg, 1 on mobile)
- Each card: service icon (generic integration icon), service name (Xero, 3CX, Reportei), "Not Connected" badge in grey, disabled "Configure" button
- Simple, minimal — just placeholders showing where integrations will live
- Also include a "Backup Status" card showing "No backup configured" or the stored timestamp from settings if it exists. Use `useSettings()` to read backup_status.

**9. Update `client/src/components/layout/Sidebar.tsx`:**
- Import and use `useSettings()` hook
- Replace the hard-coded `<span className="...">Buildable</span>` in the logo/collapse section with dynamic branding: if `branding.logoPath` exists, show `<img src={branding.logoPath} alt={branding.companyName} />` (sized to fit the 14h header area, e.g., max-h-8). Otherwise show `branding.companyName` as text.
- Apply `branding.primaryColour` to the active nav item highlight colour. Replace the hard-coded `#4573D2` references in the active state classes with inline style or CSS custom property driven by the branding colour. A practical approach: use inline `style={{ backgroundColor: branding.primaryColour + '1A', color: branding.primaryColour }}` on the active button instead of the Tailwind `bg-[#4573D2]/10 text-[#4573D2]` classes.

All components should follow Asana design language: clean whitespace, card-based sections, consistent with existing dashboard styling (see existing components for reference). Use Tailwind classes. Australian English for all labels and text.
  </action>
  <verify>
1. `cd C:/Projects/buildable_dashboard/client && npx tsc --noEmit` — TypeScript compiles clean
2. `cd C:/Projects/buildable_dashboard && npm run dev` — Both client and server start without errors
3. Navigate to `http://localhost:6000`, click "Admin Settings" in sidebar:
   - Branding section: can type company name, pick colours, upload a logo image
   - Click "Save Changes" on branding — sidebar immediately updates with new company name and/or logo
   - Pass-Through section: can add/remove items as tags, save persists
   - Alert Thresholds: sliders and number inputs work, colour zones visible, save persists
   - System Status: three greyed-out placeholder cards visible
4. Refresh the page — saved settings persist (loaded from API on mount via SettingsContext)
  </verify>
  <done>
- Admin Settings page renders with four distinct card sections (Branding, Pass-Through, Alerts, System Status)
- Logo upload works: drag-drop or click to upload, preview shown, saved to server, displayed in sidebar
- Company name and colours save and immediately reflect in sidebar via SettingsContext
- Pass-through items saved as tag list and readable by the financial deep dive endpoint
- Alert thresholds configurable with sliders showing colour zones
- System status shows placeholder cards for Xero, 3CX, Reportei
- SettingsProvider wraps the app, useSettings() hook provides branding globally
- No auto-save — all sections use explicit Save button
  </done>
</task>

</tasks>

<verification>
1. **Branding round-trip:** Upload logo + set company name + change colours -> Save -> Refresh page -> All values persist and display correctly in sidebar
2. **Pass-through integration:** Set pass-through items via Admin Settings -> Verify `GET /api/v1/settings/pass_through_categories` returns the saved array -> Financial Deep Dive endpoint uses these values (existing code at dashboard.ts line 301-307 already reads from this key)
3. **Alert thresholds persistence:** Configure thresholds -> Save -> Refresh -> Values persist with correct types (numbers, not strings)
4. **Permission middleware:** Check server logs or add a temporary console.log to verify `resolvePermission` is NOT making a DB query when permissions are already on req.user
5. **No regressions:** Existing dashboard pages (Executive Summary, Financial, Regional) still load correctly
</verification>

<success_criteria>
- ADMN-01: Branding config UI works (logo upload, company name, primary/accent colour)
- ADMN-02: Branding changes reflect immediately in app header/sidebar (via SettingsContext refresh)
- ADMN-03: Pass-through items list works (add/remove, stored in Setting table)
- ADMN-04: Alert threshold configuration works (3 metrics, warning/critical levels, colour zones)
- ADMN-05: System status cards visible (Xero, 3CX, Reportei placeholders)
- ADMN-06: Backup status display card present (informational, reads from settings)
- Permission middleware N+1 fix verified (uses cached permissions)
</success_criteria>

<output>
After completion, create `.planning/phases/01-admin-user-management/01-01-SUMMARY.md`
</output>
