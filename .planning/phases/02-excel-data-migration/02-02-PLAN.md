---
phase: 02-excel-data-migration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - client/src/components/migration/ExcelMigration.tsx
  - client/src/components/migration/MigrationUpload.tsx
  - client/src/components/migration/MigrationProgress.tsx
  - client/src/components/migration/MigrationReport.tsx
  - client/src/lib/migrationApi.ts
  - client/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Data Management page shows an 'Excel Migration' tab alongside 'Upload Data' and 'Upload History'"
    - "Clicking 'Excel Migration' tab shows a two-step wizard: Upload & Preview, then Confirm & Import"
    - "Uploading a .xlsx file shows a dry-run preview with record counts per table, sample data, and warnings"
    - "Clicking 'Start Import' streams real-time progress showing current sheet, table, record counts, and warning counts"
    - "After import completes, a summary report displays inserted/updated counts per table and all warnings"
    - "Warnings are shown inline with count badge, and a downloadable text file is available with complete warning details"
    - "The migration UI is visually consistent with the existing CSV Upload Wizard (Asana-style cards, same colour palette)"
  artifacts:
    - path: "client/src/lib/migrationApi.ts"
      provides: "API client functions for migration endpoints (upload, import, SSE progress hook)"
      exports: ["uploadWorkbook", "startImport", "useMigrationProgress"]
    - path: "client/src/components/migration/ExcelMigration.tsx"
      provides: "Two-step wizard container managing migration state machine"
      exports: ["default (ExcelMigration)"]
    - path: "client/src/components/migration/MigrationUpload.tsx"
      provides: "Step 1 UI: file upload dropzone + dry-run preview table"
      exports: ["default (MigrationUpload)"]
    - path: "client/src/components/migration/MigrationProgress.tsx"
      provides: "Step 2 UI: real-time progress bars, SSE event display, live status"
      exports: ["default (MigrationProgress)"]
    - path: "client/src/components/migration/MigrationReport.tsx"
      provides: "Final summary report with per-table stats, warnings, and download button"
      exports: ["default (MigrationReport)"]
    - path: "client/src/App.tsx"
      provides: "Excel Migration tab added to Data Management page"
  key_links:
    - from: "client/src/lib/migrationApi.ts"
      to: "/api/v1/migration"
      via: "fetch POST and EventSource GET"
      pattern: "fetch.*migration|EventSource.*migration"
    - from: "client/src/components/migration/ExcelMigration.tsx"
      to: "client/src/lib/migrationApi.ts"
      via: "imports uploadWorkbook, startImport"
      pattern: "import.*migrationApi"
    - from: "client/src/components/migration/MigrationProgress.tsx"
      to: "client/src/lib/migrationApi.ts"
      via: "imports useMigrationProgress hook"
      pattern: "useMigrationProgress"
    - from: "client/src/App.tsx"
      to: "client/src/components/migration/ExcelMigration.tsx"
      via: "renders ExcelMigration component in data_management page"
      pattern: "ExcelMigration"
---

<objective>
Build the frontend migration UI: a two-step wizard on the Data Management page that uploads .xlsx files, shows dry-run previews, streams real-time import progress, and displays a summary report with data quality warnings.

Purpose: Give administrators (Super Admin, Executive) a visual interface to import historical data from the Excel workbook. The UI should feel consistent with the existing CSV Upload Wizard's Asana-style design. This completes the Excel Data Migration feature end-to-end.

Output: Working migration UI accessible via the Data Management page that connects to the Plan 01 backend API endpoints.
</objective>

<execution_context>
@C:/Users/Dev180D/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Dev180D/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-excel-data-migration/02-01-SUMMARY.md
@client/src/App.tsx
@client/src/components/upload/UploadWizard.tsx
@server/src/routes/migration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration API client and all 4 migration UI components</name>
  <files>
    client/src/lib/migrationApi.ts
    client/src/components/migration/ExcelMigration.tsx
    client/src/components/migration/MigrationUpload.tsx
    client/src/components/migration/MigrationProgress.tsx
    client/src/components/migration/MigrationReport.tsx
  </files>
  <action>
    **migrationApi.ts** — API client for migration endpoints.

    ```typescript
    // Types matching the backend DryRunResult and MigrationResult
    export interface DryRunTable {
      tableName: string;
      recordCount: number;
      sampleRecords: Array<Record<string, any>>;
      warnings: string[];
    }

    export interface DryRunResult {
      jobId: string;
      fileName: string;
      tables: DryRunTable[];
      totalRecords: number;
      totalWarnings: number;
      allWarnings: string[];
    }

    export interface MigrationTableResult {
      tableName: string;
      inserted: number;
      updated: number;
      warnings: string[];
    }

    export interface MigrationResult {
      success: boolean;
      tables: MigrationTableResult[];
      totalInserted: number;
      totalUpdated: number;
      totalWarnings: number;
      allWarnings: string[];
    }

    export interface ProgressEvent {
      phase: 'parsing' | 'importing' | 'complete' | 'error';
      sheet?: string;
      table?: string;
      current: number;
      total: number;
      warnings: number;
      message: string;
      result?: MigrationResult; // Present when phase === 'complete'
    }
    ```

    Create functions:

    1. `async uploadWorkbook(file: File): Promise<DryRunResult>` — POST /api/v1/migration/upload with FormData, returns dry-run preview.

    2. `async startImport(jobId: string): Promise<{ status: string; jobId: string }>` — POST /api/v1/migration/import/:jobId, returns immediately.

    3. `useMigrationProgress(jobId: string | null): ProgressEvent | null` — React hook using EventSource to subscribe to SSE at /api/v1/migration/progress/:jobId. Returns latest progress event. Cleans up EventSource on unmount or when jobId changes.

    Use the existing API base URL pattern from the codebase. The Vite dev server proxies /api to localhost:6001. Use relative URLs (e.g., `/api/v1/migration/upload`).

    **ExcelMigration.tsx** — Two-step wizard container.

    State machine with 3 phases: `idle` | `preview` | `importing` | `complete`.

    ```typescript
    type MigrationPhase = 'idle' | 'preview' | 'importing' | 'complete';

    interface MigrationState {
      phase: MigrationPhase;
      dryRun: DryRunResult | null;
      jobId: string | null;
      result: MigrationResult | null;
      error: string | null;
    }
    ```

    Renders:
    - `idle` → MigrationUpload (file dropzone)
    - `preview` → MigrationUpload (showing dry-run results, with "Start Import" button)
    - `importing` → MigrationProgress (SSE progress streaming)
    - `complete` → MigrationReport (summary)

    Include a "Reset" / "Start Over" button to go back to `idle` at any phase.

    **MigrationUpload.tsx** — Step 1: Upload + dry-run preview.

    Props: `onUploadComplete(result: DryRunResult): void`, `dryRun: DryRunResult | null`, `onStartImport(): void`, `isLoading: boolean`.

    Layout:
    1. **Upload area** — Drag-and-drop zone (or click to select) that accepts only .xlsx files. Show file name after selection. Use an `<input type="file" accept=".xlsx,.xls">`. Style as a dashed-border card matching the CSV upload aesthetic.

    2. **Dry-run preview** (shown after upload) — Card with:
       - Header: "Migration Preview" with total record count and total warning count badges
       - Table showing: Table Name | Records | Warnings (one row per target table)
       - Expandable section per table showing sample records (first 3)
       - Warning summary: collapsible list showing first 20 warnings inline
       - Big green "Start Import ({N} records)" button
       - Small "Cancel" link to go back to idle

    Styling (matching Asana/existing design):
    - Cards: `bg-white rounded-lg shadow-sm border border-gray-200 p-6`
    - Primary button: `bg-[#4573D2] text-white px-6 py-2 rounded-lg hover:bg-[#3a63b8]`
    - Warning badge: `bg-[#E8A442]/10 text-[#E8A442] text-xs px-2 py-0.5 rounded-full`
    - Success badge: `bg-[#6AAF50]/10 text-[#6AAF50] text-xs px-2 py-0.5 rounded-full`
    - Error text: `text-[#D94F4F]`

    **MigrationProgress.tsx** — Step 2: Real-time progress.

    Props: `jobId: string`, `onComplete(result: MigrationResult): void`.

    Uses `useMigrationProgress(jobId)` hook to get SSE events. Displays:
    1. **Overall progress bar** — Shows current / total records as a percentage bar. Use the primary colour #4573D2 for the bar fill.
    2. **Current activity** — Shows "Parsing: {sheet name}" or "Importing: {table name}" with a spinning indicator.
    3. **Live stats** — Cards showing: Records Imported, Warnings Found. Updated in real-time.
    4. **Phase indicators** — Show which sheets have been processed (checkmarks), which is current (spinner), which are pending (grey dot).

    When `progress.phase === 'complete'`, call `onComplete(progress.result)` to transition to the report view.
    When `progress.phase === 'error'`, show error message with a "Try Again" button.

    **MigrationReport.tsx** — Final summary report.

    Props: `result: MigrationResult`, `allWarnings: string[]`, `onReset(): void`.

    Layout:
    1. **Success banner** — Green card with checkmark icon, "Migration Complete" header, total inserted + updated counts.
    2. **Per-table breakdown** — Table showing: Table Name | Inserted | Updated | Warnings. Highlight rows with warnings in amber.
    3. **Warnings section** — If warnings exist:
       - Count badge
       - First 20 warnings shown inline in a scrollable list
       - "Download Full Warning Report" button that generates a .txt file with all warnings and triggers download via `URL.createObjectURL(new Blob([...]))`
    4. **Actions** — "Run Again" button (calls onReset), and informational text: "This migration is idempotent — you can safely re-run it at any time."

    All components use Australian English (e.g., "Colour" not "Color" in any labels, though most labels here are technical).
  </action>
  <verify>
    ```bash
    cd client && npx tsc --noEmit 2>&1 | head -30
    ```
    TypeScript compilation passes. Verify all component files exist:
    ```bash
    ls client/src/components/migration/
    ls client/src/lib/migrationApi.ts
    ```
  </verify>
  <done>
    All 4 migration components and the API client are created. ExcelMigration.tsx manages the state machine. MigrationUpload shows file upload and dry-run preview. MigrationProgress streams SSE progress. MigrationReport shows the final summary with downloadable warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ExcelMigration into App.tsx Data Management page</name>
  <files>
    client/src/App.tsx
  </files>
  <action>
    Modify `client/src/App.tsx` to add the Excel Migration tab to the Data Management page.

    1. **Import the ExcelMigration component:**
       ```typescript
       import ExcelMigration from './components/migration/ExcelMigration';
       ```

    2. **Extend the DataManagementView type:**
       Change `type DataManagementView = 'upload' | 'history';` to:
       ```typescript
       type DataManagementView = 'upload' | 'history' | 'migration';
       ```

    3. **Add the "Excel Migration" tab button** in the Data Management sub-nav, alongside "Upload Data" and "Upload History":
       ```tsx
       <button
         onClick={() => setDataView('migration')}
         className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${
           dataView === 'migration'
             ? 'bg-[#4573D2]/10 text-[#4573D2]'
             : 'text-[#6B7280] hover:text-gray-900 hover:bg-gray-100'
         }`}
       >
         Excel Migration
       </button>
       ```

    4. **Render ExcelMigration when the tab is active:**
       After the existing `{dataView === 'history' && ...}` block, add:
       ```tsx
       {dataView === 'migration' && <ExcelMigration />}
       ```

    The tab order should be: Upload Data | Upload History | Excel Migration.
  </action>
  <verify>
    ```bash
    cd client && npx tsc --noEmit 2>&1 | head -20
    ```
    TypeScript compilation passes. Verify the integration:
    ```bash
    cd client && grep -n "migration" src/App.tsx
    ```
    Should show the import, the type, the button, and the render.

    Start the dev server and visually verify:
    ```bash
    cd C:/Projects/buildable_dashboard && npm run dev
    ```
    Navigate to http://localhost:6000, click "Data Management" in the sidebar, and confirm the "Excel Migration" tab appears and renders the upload UI.
  </verify>
  <done>
    Data Management page shows 3 tabs: Upload Data, Upload History, and Excel Migration. Clicking Excel Migration renders the ExcelMigration wizard. The tab styling matches the existing tabs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Excel migration feature: backend parsers, API endpoints with SSE progress, and frontend two-step wizard UI on the Data Management page. The system can parse the "Weekly Report - 30.xlsx" workbook, show a dry-run preview, import data into 10+ database tables idempotently, and display real-time progress and summary reports.
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev` from the project root
    2. Open http://localhost:6000 in a browser
    3. Navigate to "Data Management" in the sidebar
    4. Click the "Excel Migration" tab — verify it shows a file upload area
    5. Upload the workbook: `C:\Users\Dev180D\Downloads\Client_Files\Reporting\Weekly Report - 30.xlsx`
    6. Verify the dry-run preview shows:
       - Multiple target tables (financial_weekly, projects_weekly, etc.)
       - ~30 records per table (not 52)
       - Warnings for formula errors and uncached formulas
       - Sample data preview for each table
    7. Click "Start Import" and verify:
       - Progress bar moves in real-time
       - Current sheet/table names are displayed
       - Warning count updates live
    8. After completion, verify the summary report shows:
       - Inserted/updated counts per table
       - Total warnings with inline list
       - "Download Full Warning Report" button works
    9. Re-upload and re-import the same file — verify counts are identical (idempotent)
    10. Check the database (optional): verify financial_weekly has ~30 rows with data_source = 'backfilled'
  </how-to-verify>
  <resume-signal>Type "approved" if migration works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation (both client and server):**
   ```bash
   cd server && npx tsc --noEmit
   cd client && npx tsc --noEmit
   ```

2. **Data Management page has 3 tabs:**
   Navigate to Data Management → Upload Data, Upload History, and Excel Migration tabs all visible.

3. **Upload and dry-run works:**
   Upload .xlsx file → see table counts, warnings, sample data.

4. **Import works:**
   Click Start Import → progress streams → summary report displays.

5. **Idempotent:**
   Re-import → same counts, no duplicates.

6. **Warnings captured:**
   Formula errors and uncached formulas appear in warning list.
   Download button produces a text file.
</verification>

<success_criteria>
- Excel Migration tab visible on Data Management page
- .xlsx upload shows dry-run preview with per-table record counts
- Import streams real-time progress via SSE
- Summary report shows inserted/updated counts and warnings
- Warning download produces complete .txt file
- UI matches existing Asana-style design (white cards, soft shadows, primary colour #4573D2)
- Migration is idempotent (re-run produces identical results)
</success_criteria>

<output>
After completion, create `.planning/phases/02-excel-data-migration/02-02-SUMMARY.md`
</output>
